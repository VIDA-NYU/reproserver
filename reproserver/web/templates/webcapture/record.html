{% extends "base.html" %}

{% block content %}

<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="{{ reverse_url('index') }}">Home</a></li>
    <li class="breadcrumb-item"><a href="{{ experiment_url }}">Package {{ run.upload.filename | truncate(60) }}</a></li>
    <li class="breadcrumb-item"><a href="{{ reverse_url('webcapture_dashboard', upload_short_id) }}">Web capture</a></li>
    <li class="breadcrumb-item active" aria-current="page">Live record</li>
  </ol>
</nav>

<h1>Live recording here (from browser)</h1>

<div class="card my-3">
  <p class="card-header">
    Run log
  </p>
  <div>
    <div class="card-body">
      <pre id="log" style="max-height: 200px">{% for line in log %}{{ line }}
{% endfor %}</pre>
    </div>
  </div>
</div>

<script>
var log_lines = {{ log | length }};
function update_page() {
  var req = new XMLHttpRequest();
  req.addEventListener("load", function(e) {
    if(this.status == 200) {
      if(this.response.log.length > 0) {
        log_lines += this.response.log.length;
        var dom_log = document.getElementById("log");
        dom_log.textContent += this.response.log.join("\n") + "\n";
      }
      if(this.response.done) {
        return;
      }
    }
    setTimeout(update_page, 3000);
  });
  req.responseType = "json";
  req.open("GET", "{{ reverse_url('results_json', run.short_id) }}?log_from=" + log_lines);
  req.setRequestHeader("Accept", "application/json");
  req.send();
}

setTimeout(update_page, 3000);

window.addEventListener("load", () => {
  document.querySelector("#upload").addEventListener("click", doUpload);
});

async function doUpload() {
  const recorder = document.querySelector("record-web-page");
  if (!recorder) {
    return;
  }

  const blobUrl = await recorder.doDownload();
  console.log(blobUrl);

  const resp = await fetch(blobUrl);
  const blob = await resp.blob();

  const f = new FormData();
  f.append("wacz_file", blob, "wacz_file.wacz");
  f.append("hostname", "localhost");
  f.append("port_number", {{ port_number }});

  const headers = {"Accept": "application/json"};

  const resp2 = await fetch("{{ reverse_url('webcapture_upload_wacz', upload_short_id) }}", {method: "POST", headers, body: f});

  const json = await resp2.json();

  // todo: add error handling
  if (json.redirect_url) {
    window.location.href = json.redirect_url;
  }
}

</script>

<p id="web-loading"></p>

<script type="x-template" id="web">
<button class="btn btn-default" id="upload">Upload WACZ</button>
<record-web-page
  style="height: 500px; display: flex; margin-top: 10px; border: 1px solid black;"
  url="http://localhost:{{ port_number }}/"
  replayBase="/static/replay/"
  coll="{{ run.short_id }}"
  noWebWorker
  config='{"hostProxy": {"localhost:{{ port_number }}": {"prefix": "/results/{{ run.short_id }}/port/{{ port_number }}", "pathOnly": true}}}'
>
</record-web-page>
</script>

<script>
var web_status = "starting";

function web_update_status() {
  if(web_status == "ready") {
    document.getElementById("web-loading").style.display = "none";
    var web = document.getElementById("web");
    var web_widget = document.createElement("div");
    web_widget.setAttribute("id", "web");
    web_widget.innerHTML = web.innerHTML;
    web.parentNode.replaceChild(web_widget, web);
  } else if(web_status == "starting") {
    document.getElementById("web-loading").innerText = "The package is starting up and is not yet ready to serve web requests. Please wait...";
  } else if(web_status == "toolong") {
    document.getElementById("web-loading").innerHTML = "The package is not ready to serve web requests after 30 seconds.<br>Please check the logs above to see if something went wrong with startup, and if you have the right port number (you entered {{ run.ports[0].port_number }} into ReproServer).";
  }
}

function web_check() {
  var req = new XMLHttpRequest();
  req.addEventListener("load", function(e) {
    if(this.status != 503) {
      console.log("Got status " + this.status + ", enabling web widget");
      web_status = "ready";
    } else {
      setTimeout(web_check, 2000);
    }
    web_update_status();
  });
  req.open("GET", "/results/{{ run.short_id }}/port/{{ run.ports[0].port_number }}/");
  req.send();
}
web_check();

setTimeout(function() { web_status = "toolong"; web_update_status(); }, 30000);
</script>
{% endblock content %}

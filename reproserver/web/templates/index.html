<!-- {% set current_nav = 'reproduce' %} -->

{% extends "base.html" %}

{% block content %}
<div class="container grey-bg p-5">
  <h1><strong>Share reproducible work</strong></h1>
  <p>Reprozip allows you to automatically pack your web application along with necessary libraries, configuration
    files and environment variables,</p>
  <p>So you can rerun the packed web application on a new machine without tracking and installing the dependencies
    manually</p>
  <p>This application is still in progess, Currently It enables you reproduce Reprozip packages from web browser,
    without having to install ReproUnzip on your computer</p>
  <a href="/">Learn More</a>

  <div class="row mt-5 p-5">
    <div class="col-lg">
      <div class="circle-icon rounded-circle" style="opacity: 40%;">
        <h3>Trace</h3>
      </div>
      <p class="text-center mt-3">Trace your web application in the terminal</p>
    </div>
    <div class="col-lg arrow-icon mt-5 d-none d-lg-block">
      <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="currentColor" class="bi bi-arrow-right"
        viewBox="0 0 16 16">
        <path fill-rule="evenodd"
          d="M1 8a.5.5 0 0 1 .5-.5h11.793l-3.147-3.146a.5.5 0 0 1 .708-.708l4 4a.5.5 0 0 1 0 .708l-4 4a.5.5 0 0 1-.708-.708L13.293 8.5H1.5A.5.5 0 0 1 1 8z">
        </path>
      </svg>
    </div>
    <div class="col-lg">
      <div class="circle-icon rounded-circle" style="opacity: 60%;">
        <h3>Pack</h3>
      </div>
      <p class="text-center mt-3">Generate a reprozip bundle with server side elements</p>
    </div>
    <div class="col-lg arrow-icon mt-5 d-none d-lg-block">
      <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="currentColor" class="bi bi-arrow-right"
        viewBox="0 0 16 16">
        <path fill-rule="evenodd"
          d="M1 8a.5.5 0 0 1 .5-.5h11.793l-3.147-3.146a.5.5 0 0 1 .708-.708l4 4a.5.5 0 0 1 0 .708l-4 4a.5.5 0 0 1-.708-.708L13.293 8.5H1.5A.5.5 0 0 1 1 8z">
        </path>
      </svg>
    </div>
    <div class="col-lg">
      <div class="circle-icon rounded-circle" style="opacity: 80%;">
        <h3>Record</h3>
      </div>
      <p class="text-center mt-3">Archive client side assets into your reprozip bundle</p>
    </div>
    <div class="col-lg arrow-icon mt-5 d-none d-lg-block">
      <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="currentColor" class="bi bi-arrow-right"
        viewBox="0 0 16 16">
        <path fill-rule="evenodd"
          d="M1 8a.5.5 0 0 1 .5-.5h11.793l-3.147-3.146a.5.5 0 0 1 .708-.708l4 4a.5.5 0 0 1 0 .708l-4 4a.5.5 0 0 1-.708-.708L13.293 8.5H1.5A.5.5 0 0 1 1 8z">
        </path>
      </svg>
    </div>
    <div class="col-lg">
      <div class="circle-icon rounded-circle" style="opacity: 100%;">
        <h3>Replay</h3>
      </div>
      <p class="text-center mt-3">Replay and preview your web application</p>
    </div>
  </div>
</div>

<div class="container col-md-10 my-5 p-5">
  <h1><strong>Select a package to upload</strong></h1>
  <form method="POST" action="{{ reverse_url('upload') }}" enctype="multipart/form-data" name="rpz_upload">
    {{ xsrf_form_html() }}
    <div class="mb-3">
      <label for="rpz_file" class="form-label">Upload a <code>.rpz</code> file</label>
      <input type="file" class="form-control" id="rpz_file" name="rpz_file" placeholder="experiment.rpz" accept=".rpz">

    </div>
    <div class="mb-3">
      <label for="rpz_url" class="form-label">or provide a package's URL</label>
      <input type="text" class="form-control" id="rpz_url" name="rpz_url" placeholder="http://experiment.rpz">
    </div>

    <div class="progress mb-3" hidden>
      <div id="progress_bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"
        aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%">
      </div>
    </div>
    <h3 id="status"></h3>
    
    <button class="btn btn-primary" disabled>Upload</button>
  </form>
</div>

<div class="container grey-bg p-5">
  <h2 class="lead">Examples</h4>
    <p><a href="{{ reverse_url('reproduce_repo', 'osf.io', 'r2ptb') }}">bechdel.rpz</a>: Attempt to replicate the
      findings from a FiveThirtyEight article examining gender bias in the movie business</p>
    <p><a href="{{ reverse_url('reproduce_repo', 'osf.io', '5ztp2') }}">digits_sklearn_opencv.rpz</a>: Recognizing the
      value of hand-written digits using OpenCV and scikit-learn</p>
    <p><a href="{{ reverse_url('reproduce_repo', 'osf.io', '5ke97') }}">bash-count.rpz</a>: Simple bash script
      counting the lines in a file</p>

</div>
<script>
  var fileInput = document.getElementById('rpz_file');
  var urlInput = document.getElementById('rpz_url');
  var submitButton = fileInput.closest('form').querySelector('button');
  var progressBar = document.getElementsByClassName('progress')[0];
  function updateUploadForm() {
    if (fileInput.value || urlInput.value) {
      submitButton.hidden = false;
      submitButton.removeAttribute('disabled');
    } else {
      progressBar.hidden = true;
      submitButton.setAttribute('disabled', true);
    }
  }

  function _(el) {
    return document.getElementById(el);
  }

  function transferComplete(event) {
    _("status").innerHTML = "Uploading completed... please wait";
  }

  function transferFailed(event) {
    _("status").innerHTML = "Uploading Failed";
  }

  function transferCanceled(event) {
    _("status").innerHTML = "Uploading Aborted";
  }

  function updateProgress(event) {
    var percent = (event.loaded / event.total) * 100;
    _("progress_bar").setAttribute('aria-valuenow', Math.round(percent));
    _("progress_bar").style.width = Math.round(percent) + "%";
    _("status").innerHTML = "Uploading..." + Math.round(percent) + "%";
  }

  const form = document.forms.namedItem("rpz_upload");
  form.addEventListener("submit",
    (event) => {
      progressBar.hidden = false;   // make progressbar visible
      submitButton.hidden = true;   // hide submit button
      const formData = new FormData(form);
      const request = new XMLHttpRequest();
      request.upload.addEventListener("progress", updateProgress);
      request.upload.addEventListener("error", transferFailed);
      request.upload.addEventListener("abort", transferCanceled);
    
      request.open("POST", "{{ reverse_url('upload') }}", true);

      request.onload = (progress) => {
        if(request.status === 200){
          _("status").innerHTML = "Uploading completed... please wait";
          window.location.href = request.responseURL;
        }
        else{
          console.error(`Error ${request.status} occurred when trying to upload your file`);
        }
      };
      request.send(formData);
      event.preventDefault();
    },
    false
  );
    
  fileInput.addEventListener('change', updateUploadForm);
  urlInput.addEventListener('input', updateUploadForm);
</script>
{% endblock content %}